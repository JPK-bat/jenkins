# ------------ Stage 1: Build ------------
FROM maven:3.9.9-eclipse-temurin-21-alpine AS build


WORKDIR /app

# Copy all project files including multi-module structure
COPY . .

# Copy external JAR dependency
COPY src target

# Install external JARs into local Maven repo (script must exist in lib/)
RUN chmod +x lib/install-maven-dependencies.sh && \
    ./lib/install-maven-dependencies.sh

# Build the entire project, skip tests to speed up build
RUN mvn clean install -DskipTests


# ------------ Stage 2: Runtime ------------
FROM eclipse-temurin:21-jre-alpine-3.22

WORKDIR /app

# Copy the runnable JAR (update path if module changes)
COPY --from=build **/target/*.jar ./app.jar

# Copy property files
COPY src target

# Set Spring config location environment variable
ENV SPRING_CONFIG_LOCATION=file:/app/*.properties

# Expose application port
EXPOSE 7037

# Run the Spring Boot application
ENTRYPOINT ["java", "-jar", "/app/app.jar"]
